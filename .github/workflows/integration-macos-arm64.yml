name: Integration Tests (macOS ARM64)

on:
  pull_request:
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'integration/**'
      - '.github/workflows/integration-*.yml'
  push:
    branches:
      - master
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'integration/**'
      - '.github/workflows/integration-*.yml'

jobs:
  integration:
    name: Integration
    runs-on: warp-macos-15-arm64-6x
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Verify Apple Containerization
        run: |
          if ! command -v container &>/dev/null; then
            echo "::error::Apple container CLI not found"
            exit 1
          fi
          container --version

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | container registry login ghcr.io --username "${{ github.actor }}" --password-stdin

      - name: Pull container image
        run: container image pull ghcr.io/gilmanlab/headjack:base

      - name: Build hjk binary
        run: go build -o hjk .

      - name: Run integration tests
        env:
          HEADJACK_TEST_RUNTIME: apple
          HJK_BINARY: ${{ github.workspace }}/hjk
        run: go test -v -tags=integration -timeout=30m ./integration/...
